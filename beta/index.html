<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.googletagmanager.com/gtag/js?id=UA-132320676-1" async></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-132320676-1');
    </script>

    <link href="assets/css/font.css" rel="stylesheet">
    <link href="assets/css/slkartan.css?v=20190120" rel="stylesheet">
  </head>

  <body>
    <div class="wrapper">
      <div class="side">
        <header>
          <h1>SL<strong>KARTAN</strong></h1>
          <div class="version">v 0.1a</div>
          <button class="button" id="get_device_position">GET_POS</button>

          <!-- Testing dropdown alternatives -->
          <div id="dropdowndiv">

            <!-- Inputs -->
            <input type="text" placeholder="Vart befinner du dig ?" id="where_are_you">
            <input type="text" placeholder="Vart vill du åka ?"     id="where_to_go" onfocusout="hidelist()" onfocus="filterlist()" onkeyup="filterlist()">

            <!-- The actual dropdown content -->
            <div class="dropdowncontent" id="dropdowncontent">

              <!-- Centralen, handle separetely -->
              <a href="#about"><span class="listtext">T-Centralen         </span><div class="listitem"><label class="pink">&nbsp;</label><label class="blue">&nbsp</label><label class="green">&nbsp;</label><label class="red">&nbsp;</label></div></a>

              <!-- BLÅ -->
              <!-- 10, 11, 17, 18, 19 -->
              <a href="#about"><span class="listtext">Fridhemsplan        </span><div class="listitem"><label class="blue">10 11</label><label class="green">17 18 19</label></div></a>

              <!-- 10, 11 -->
              <a href="#about"><span class="listtext">Kungsträdgården     </span><div class="listitem"><label class="blue">10 11</label></div></a>
              <a href="#about"><span class="listtext">Rådhuset            </span><div class="listitem"><label class="blue">10 11</label></div></a>
              <a href="#about"><span class="listtext">Stadshagen          </span><div class="listitem"><label class="blue">10 11</label></div></a>
              <a href="#about"><span class="listtext">Västra Skogen       </span><div class="listitem"><label class="blue">10 11</label></div></a>

              <!-- 10 -->
              <a href="#about"><span class="listtext">Huvudsta            </span><div class="listitem"><label class="blue">10 11</label></div></a>
              <a href="#about"><span class="listtext">Solna Strand        </span><div class="listitem"><label class="blue">10 11</label></div></a>

              <!-- 10, 43, 44 -->
              <a href="#about"><span class="listtext">Sundbyberg Centrum  </span><div class="listitem"><label class="blue">10</label><label class="pink">43 44</label></div></a>
              <a href="#about"><span class="listtext">Solna Centrum       </span><div class="listitem"><label class="blue">10</label><label class="pink">43 44</label></div></a>

              <!-- 10 -->
              <a href="#about"><span class="listtext">Duvbo               </span><div class="listitem"><label class="blue">10 11</label></div></a>
              <a href="#about"><span class="listtext">Rissne              </span><div class="listitem"><label class="blue">10 11</label></div></a>
              <a href="#about"><span class="listtext">Rinkeby             </span><div class="listitem"><label class="blue">10 11</label></div></a>
              <a href="#about"><span class="listtext">Tensta              </span><div class="listitem"><label class="blue">10 11</label></div></a>
              <a href="#about"><span class="listtext">Hjulsta             </span><div class="listitem"><label class="blue">10 11</label></div></a>

              <!-- 11 -->
              <a href="#about"><span class="listtext">Näckrosen           </span><div class="listitem"><label class="blue">11</label></div></a>
              <a href="#about"><span class="listtext">Hallonbergen        </span><div class="listitem"><label class="blue">11</label></div></a>
              <a href="#about"><span class="listtext">Kista               </span><div class="listitem"><label class="blue">11</label></div></a>
              <a href="#about"><span class="listtext">Husby               </span><div class="listitem"><label class="blue">11</label></div></a>
              <a href="#about"><span class="listtext">Akalla              </span><div class="listitem"><label class="blue">11</label></div></a>

              <!-- RÖD -->
              <!-- 13 -->
              <a href="#about"><span class="listtext">Norsborg            </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Hallunda            </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Alby                </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Fittja              </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Masmo               </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Vårby Gård          </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Vårberg             </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Skärholmen          </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Sätra               </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Bredäng             </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Mälarhöjden         </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Axelsberg           </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Örnsberg            </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Aspudden            </span><div class="listitem"><label class="red">13</label></div></a>

              <!-- 13, 14 -->
              <a href="#about"><span class="listtext">Liljeholmen         </span><div class="listitem"><label class="red">13 14</label></div></a>
              <a href="#about"><span class="listtext">Hornstull           </span><div class="listitem"><label class="red">13 14</label></div></a>
              <a href="#about"><span class="listtext">Zinkensdamm         </span><div class="listitem"><label class="red">13 14</label></div></a>

              <!-- 13, 14 -->
              <a href="#about"><span class="listtext">Mariatorget         </span><div class="listitem"><label class="red">13 14</label><label class="pink">40 - 48</label></div></a>

              <!-- 13, 14, 17, 18, 19 -->
              <a href="#about"><span class="listtext">Slussen             </span><div class="listitem"><label class="red">13 14</label><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Gamla Stan          </span><div class="listitem"><label class="red">13 14</label><label class="green">17 18 19</label></div></a>

              <!-- 13, 14 -->
              <a href="#about"><span class="listtext">Östermalmstorg      </span><div class="listitem"><label class="red">13 14</label></div></a>

              <!-- GRÖN -->
              <!-- 17 -->
              <a href="#about"><span class="listtext">Skarpnäck      </span><div class="listitem"><label class="green">17</label></div></a>
              <a href="#about"><span class="listtext">Bagarmossen    </span><div class="listitem"><label class="green">17</label></div></a>
              <a href="#about"><span class="listtext">Kärrtorp       </span><div class="listitem"><label class="green">17</label></div></a>
              <a href="#about"><span class="listtext">Björkhagen     </span><div class="listitem"><label class="green">17</label></div></a>
              <a href="#about"><span class="listtext">Hammarbyhöjden </span><div class="listitem"><label class="green">17</label></div></a>
              <a href="#about"><span class="listtext">Skärmarbrink   </span><div class="listitem"><label class="green">17</label></div></a>

              <!--17, 18, 19 -->
              <a href="#about"><span class="listtext">Gullmarsplan       </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Skanstull          </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Medborgarplatsen   </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Hötorget           </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Rådmansgatan       </span><div class="listitem"><label class="green">17 18 19</label></div></a>

              <!-- 17, 18, 19, 40, 41, 42, 43, 44, 45, 48 -->
              <a href="#about"><span class="listtext">Odenplan           </span><div class="listitem"><label class="green">17 18 19</label><label class="pink">40 - 48</label></div></a>


              <!--17, 18, 19 -->
              <a href="#about"><span class="listtext">S:t Eriksplan      </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Thorildsplan       </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Kristineberg       </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Alvik              </span><div class="listitem"><label class="green">17 18 19</label></div></a>

              <a href="#about"><span class="listtext">Stora Mossen       </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Abrahamsberg       </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Brommaplan         </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Åkeshov            </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Ängbyplan          </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Islandstorget      </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Blackeberg         </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Råcksta            </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Vällingby          </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Johannelund        </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Hässelby Gård      </span><div class="listitem"><label class="green">17 18 19</label></div></a>

              <!-- 18 -->
              <a href="#about"><span class="listtext">Farsta Strand      </span><div class="listitem"><label class="green">18</label><label class="pink">42 43 45</label></div></a>
              <a href="#about"><span class="listtext">Farsta             </span><div class="listitem"><label class="green">18</label></div></a>
              <a href="#about"><span class="listtext">Hökarängen         </span><div class="listitem"><label class="green">18</label></div></a>
              <a href="#about"><span class="listtext">Gubbängen          </span><div class="listitem"><label class="green">18</label></div></a>
              <a href="#about"><span class="listtext">Tallkrogen         </span><div class="listitem"><label class="green">18</label></div></a>
              <a href="#about"><span class="listtext">Skogskyrkogården   </span><div class="listitem"><label class="green">18</label></div></a>
              <a href="#about"><span class="listtext">Sandsborg          </span><div class="listitem"><label class="green">18</label></div></a>
              <a href="#about"><span class="listtext">Blåsut             </span><div class="listitem"><label class="green">18</label></div></a>

              <!-- 19 -->
              <a href="#about"><span class="listtext">Hagsätra           </span><div class="listitem"><label class="green">19</label></div></a>
              <a href="#about"><span class="listtext">Rågsved            </span><div class="listitem"><label class="green">19</label></div></a>
              <a href="#about"><span class="listtext">Högdalen           </span><div class="listitem"><label class="green">19</label></div></a>
              <a href="#about"><span class="listtext">Bandhagen          </span><div class="listitem"><label class="green">19</label></div></a>
              <a href="#about"><span class="listtext">Stureby            </span><div class="listitem"><label class="green">19</label></div></a>
              <a href="#about"><span class="listtext">Svedmyra           </span><div class="listitem"><label class="green">19</label></div></a>
              <a href="#about"><span class="listtext">Sockenplan         </span><div class="listitem"><label class="green">19</label></div></a>
              <a href="#about"><span class="listtext">Enskede Gård       </span><div class="listitem"><label class="green">19</label></div></a>
              <a href="#about"><span class="listtext">Globen             </span><div class="listitem"><label class="green">19</label></div></a>


              <!-- 40, 45 -->
              <a href="#about"><span class="listtext">Uppsala Central    </span><div class="listitem"><label class="pink">40 45</label></div></a>
              <a href="#about"><span class="listtext">Knivsta            </span><div class="listitem"><label class="pink">40 45</label></div></a>
              <a href="#about"><span class="listtext">Arlanda            </span><div class="listitem"><label class="pink">40 45</label></div></a>

              <!-- 40, 41, 42, 45 -->
              <a href="#about"><span class="listtext">Upplands Väsby     </span><div class="listitem"><label class="pink">40 41 42 45</label></div></a>
              <a href="#about"><span class="listtext">Rotebro            </span><div class="listitem"><label class="pink">40 41 42 45</label></div></a>
              <a href="#about"><span class="listtext">Norrviken          </span><div class="listitem"><label class="pink">40 41 42 45</label></div></a>
              <a href="#about"><span class="listtext">Häggvik            </span><div class="listitem"><label class="pink">40 41 42 45</label></div></a>
              <a href="#about"><span class="listtext">Sollentuna         </span><div class="listitem"><label class="pink">40 41 42 45</label></div></a>
              <a href="#about"><span class="listtext">Helenelund         </span><div class="listitem"><label class="pink">40 41 42 45</label></div></a>
              <a href="#about"><span class="listtext">Ulriksdal          </span><div class="listitem"><label class="pink">40 41 42 45</label></div></a>
              <a href="#about"><span class="listtext">Solna              </span><div class="listitem"><label class="pink">40 41 42 45</label></div></a>

              <!-- 40, 41, 42, 43, 44, 45, 48 -->
              <a href="#about"><span class="listtext">Stockholm Södra    </span><div class="listitem"><label class="pink">40 - 48</label><label class="red">13 14</label></div></a>
              <a href="#about"><span class="listtext">Årstaberg          </span><div class="listitem"><label class="pink">40 - 48</label></div></a>
              <a href="#about"><span class="listtext">Älvsjö             </span><div class="listitem"><label class="pink">40 - 48</label></div></a>

              <!-- 40, 41, 44, 48 -->
              <a href="#about"><span class="listtext">Stuvsta            </span><div class="listitem"><label class="pink">40 41 44 48</label></div></a>
              <a href="#about"><span class="listtext">Huddinge           </span><div class="listitem"><label class="pink">40 41 44 48</label></div></a>
              <a href="#about"><span class="listtext">Flemmingsberg      </span><div class="listitem"><label class="pink">40 41 44 48</label></div></a>
              <a href="#about"><span class="listtext">Tullinge           </span><div class="listitem"><label class="pink">40 41 44 48</label></div></a>
              <a href="#about"><span class="listtext">Tumba              </span><div class="listitem"><label class="pink">40 41 44 48</label></div></a>
              <a href="#about"><span class="listtext">Rönninge           </span><div class="listitem"><label class="pink">40 41 44 48</label></div></a>
              <a href="#about"><span class="listtext">Östertälje         </span><div class="listitem"><label class="pink">40 41 44 48</label></div></a>
              <a href="#about"><span class="listtext">Södertälje Hamn    </span><div class="listitem"><label class="pink">40 41 44 48</label></div></a>
              <a href="#about"><span class="listtext">Södertälje Centrum </span><div class="listitem"><label class="pink">40 41 44 48</label></div></a>

              <!-- 42, 43, 45 -->
              <a href="#about"><span class="listtext">Trångsund          </span><div class="listitem"><label class="pink">42 43 45</label></div></a>
              <a href="#about"><span class="listtext">Skogås             </span><div class="listitem"><label class="pink">42 43 45</label></div></a>
              <a href="#about"><span class="listtext">Handen             </span><div class="listitem"><label class="pink">42 43 45</label></div></a>
              <a href="#about"><span class="listtext">Jordbro            </span><div class="listitem"><label class="pink">42 43 45</label></div></a>
              <a href="#about"><span class="listtext">Västerhaninge      </span><div class="listitem"><label class="pink">42 43 45</label></div></a>
              <a href="#about"><span class="listtext">Krigslida          </span><div class="listitem"><label class="pink">42 43 45</label></div></a>
              <a href="#about"><span class="listtext">Tungelsta          </span><div class="listitem"><label class="pink">42 43 45</label></div></a>
              <a href="#about"><span class="listtext">Hemforsa           </span><div class="listitem"><label class="pink">42 43 45</label></div></a>
              <a href="#about"><span class="listtext">Segersäng          </span><div class="listitem"><label class="pink">42 43 45</label></div></a>
              <a href="#about"><span class="listtext">Ösmo               </span><div class="listitem"><label class="pink">42 43 45</label></div></a>
              <a href="#about"><span class="listtext">Nynäsgård          </span><div class="listitem"><label class="pink">42 43 45</label></div></a>
              <a href="#about"><span class="listtext">Gröndalsviken      </span><div class="listitem"><label class="pink">42 43 45</label></div></a>

              <!-- 48 -->
              <a href="#about"><span class="listtext">Södertälje Syd     </span><div class="listitem"><label class="pink">48</label></div></a>
              <a href="#about"><span class="listtext">Järna              </span><div class="listitem"><label class="pink">48</label></div></a>
              <a href="#about"><span class="listtext">Mölnbo             </span><div class="listitem"><label class="pink">48</label></div></a>
              <a href="#about"><span class="listtext">Gnesta             </span><div class="listitem"><label class="pink">48</label></div></a>

              <!-- 41, 42 -->
              <a href="#about"><span class="listtext">Märsta             </span><div class="listitem"><label class="pink">41 42</label></div></a>
              <a href="#about"><span class="listtext">Rosersberg         </span><div class="listitem"><label class="pink">41 42</label></div></a>

              <!-- 43, 44 -->
              <a href="#about"><span class="listtext">Bålsta             </span><div class="listitem"><label class="pink">43 44</label></div></a>
              <a href="#about"><span class="listtext">Bro                </span><div class="listitem"><label class="pink">43 44</label></div></a>
              <a href="#about"><span class="listtext">Kungsängen         </span><div class="listitem"><label class="pink">43 44</label></div></a>
              <a href="#about"><span class="listtext">Kallhäll           </span><div class="listitem"><label class="pink">43 44</label></div></a>
              <a href="#about"><span class="listtext">Jakobsberg         </span><div class="listitem"><label class="pink">43 44</label></div></a>
              <a href="#about"><span class="listtext">Barkaby            </span><div class="listitem"><label class="pink">43 44</label></div></a>
              <a href="#about"><span class="listtext">Spånga             </span><div class="listitem"><label class="pink">43 44</label></div></a>

            </div>
          </div>

          <!-- Testing location api -->
          <div>
            <ol id="posfound"></ol>
          </div>
        </header>

        <!-- Header Tunnelbana-->
        <div class="type">
          <h2>
            <img src="assets/imgs/tbana.png">
            <span>
              Tunnelbana
              <strong>Metro</strong>
            </span>
          </h2>

          <!-- Blue line -->
          <div class="line blue" data-color="blue">
            <div>
              <label>10</label>
              <label>11</label>
              <figure></figure>
            </div>
            <p>Blå linjen <strong>Blue Line</strong></p>
          </div>

          <!-- Red line -->
          <div class="line red" data-color="red">
            <div>
              <label>13</label>
              <label>14</label>
              <figure></figure>
            </div>
            <p>Röda linjen <strong>Red Line</strong></p>
          </div>


          <!-- Green line -->
          <div class="line green" data-color="green">
            <div>
              <label>17</label>
              <label>18</label>
              <label>19</label>
              <figure></figure>
            </div>
            <p>Gröna linjen <strong>Green Line</strong></p>
          </div>
        </div>

        <!-- Header Pendel -->
        <div class="type">
          <h2>
            <img src="assets/imgs/pendel.png">
            <span>
              Pendeltåg
              <strong>Commuter rail</strong>
            </span>
          </h2>

          <!-- All pendel lines -->
          <div class="line pink" data-color="pink">
            <div>
              <label>40</label>
              <label>41</label>
              <label>42</label>
              <label>43</label>
              <label>44</label>
              <label>45</label>
              <label>48</label>
              <figure></figure>
            </div>
            <!-- <p>Pendeltåg <strong>Commuter rail</strong></p>-->
          </div>
        </div>
      </div>

      <!-- The actual maps -->
      <div class="content">
        <div class="map">
          <div class="position"></div>
            <img class="slmap all"   src="assets/imgs/maps/slmap_all_line.png"   style="display:block">
            <img class="slmap blue"  src="assets/imgs/maps/slmap_blue_line.png"  style="display:none">
            <img class="slmap green" src="assets/imgs/maps/slmap_green_line.png" style="display:none">
            <img class="slmap red"   src="assets/imgs/maps/slmap_red_line.png"   style="display:none">
            <img class="slmap pink"  src="assets/imgs/maps/slmap_pink_line.png"  style="display:none">
        </div>
      </div>
    </div>

    <div id="map_dummy" style="display:none"></div>

    <script>

      // Stuff we do when dom is ready, this should be fixed with
      // proper css,
      //$(document).ready(function(){

      //  // Sort of hacky, dont really care though,
      //  var width = $("#wheretogoinput").outerWidth();
      //  var height = $(window).height()-150;

      //  $(".dropdowncontent").css("max-width",width);
      //  $(".dropdowncontent").css("min-width",width);
      //  $(".dropdowncontent").css("max-height",height);
      //});



      // * * * *
      //
      // Bindings,
      //
      //


      // Toggle different lines when clicking,
      $(".line").on("click", function() {
        lineColor = $(this).data("color");
        toggleLine(lineColor);
      });


      // Get the device's position when clicked,
      $("#get_device_position").on("click", function() {
        get_device_position();
      });

      // Show the list of stations on focus, keyup events,
      $("#where_are_you").on("keyup focus", function() {
        filter_list($(this));
      });

      // Show the list of stations on focus, keyup events,
      $("#where_are_you, #where_to_go").on("focusout", function() {
        hide_list();
      });



      //$("a").on("click", function() {
      //  lineColor = $(this).data("color")
      //  console.log($(this).children('div.listitem').find('label').attr('class'))
      //});






      // * * * *
      //
      // Functions,
      //
      //


      // Function that will filter the dropdown list based on input,
      function filter_list(input){

        var filter, found, div, a, i;
        var dropdowncontent = document.getElementById("dropdowncontent");
        var offset          = input.offset().top+input.outerHeight();
        var height          = window.innerHeight - 140;

        // Size the dropdown menu,
        // TODO Fix so menu adopts when phone keyboard is brought out,
        dropdowncontent.style.top       = offset;
        dropdowncontent.style.width     = input.outerWidth();
        dropdowncontent.style.maxHeight = height;

        // Get the input,
        filter = input.val().toLowerCase();

        // Hide content if we dont have any input,
        if (filter == ""){
          dropdowncontent.style.display = "none"
          return
        }

        // Get all a's within our dropdown
        a = dropdowncontent.getElementsByTagName("a");

        // Loop all a's and match to our filter,
        for (i = 0; i < a.length; i++) {
          txtValue = a[i].textContent || a[i].innerText;
          if (txtValue.toLowerCase().indexOf(filter) > -1) {
            a[i].style.display = "";
            found=1;
          } else {
            a[i].style.display = "none";
          }
        }

        // This is just to hide the whole div, otherwise it leaves
        // a mark on the search box
        if (found){
          dropdowncontent.style.display="block";
        }else{
          dropdowncontent.style.display="none";
        }
      }



      // Function that just will hide the dropdown, called when input focus
      // is lost,
      function hide_list(){
        var dropdowncontent = document.getElementById("dropdowncontent");
            dropdowncontent.style.display = "none"
      }



      // Function that is beeing called when we ask for the device location.
      // Callbacks handle the result from the geolocation api.
      function get_device_position() {

        // Handle devices that don't support geolocation functionality,
        if (!("geolocation" in navigator)) {
          $("#posfound").html('<li>FEL : Kan inte använda GPS funktionalitet.</li>');
          return;
        }

        // Set accuracy to high, and give device ten seconds to find its position.
        // Lets see how well this works,
        var options = {
          enableHighAccuracy : true,
          timeout            : 10000
        };

        // Get the current position, callbacks handle the result
        navigator.geolocation.getCurrentPosition(callback_handle_position_success,
                                                 callback_handle_position_error,
                                                 options);
      }



      // Function that can be called to get nearest station from lat, lng.
      // Thats a bit of strecting the truth since my javascript skills are limited,
      // calling this function will actually do everything that we kinda want
      // to do with our response data,
      function get_nearest_station_from_backend(lat,lng){

        // Reset list,
        $("#posfound").html('');

        var backend_url   = "https://backend.slkartan.se/php/ret_nearest_station.php";
        var real_position = $("#where_are_you").val();

        // To debug real locations vs returned location,
        if (real_position == "") { real_position = "NOT_SET"; }

        // Old school, classic ajax request,
        var epoch_ajax_start = (new Date).getTime();
        $.ajax({
          url         : backend_url,
          type        : "post",
          data        : "lat="+lat+"&lng="+lng+"&realpos="+real_position,
          dataType    : "json",

          // On success,
          success: function (response) {
            console.log(response);
            found_stations = response;

            // Zero stations returned, or some internal error.
            if (found_stations.length < 1){
              $("#posfound").html('<li>Ingen tunnelbanestation hittad inom 500 meter '+epoch_ajax_start+'.</li>');
              return;
            }

            // Just populate the list with stations,
            callback_populate_stations(found_stations,lat,lng,epoch_ajax_start)
          },

          // On error,,
          error: function(jqXHR, textStatus, errorThrown) {
             console.log(textStatus, errorThrown);
             $("#posfound").html('<li>Ett internt fel har uppstått.</li>');
          }
        });
      }






      // * * * *
      //
      // Callback functions,
      //
      //



      // Callback function that will handle the coordinates returned from the
      // geolocation api.
      function callback_handle_position_success(position) {

        var lat = position.coords.latitude;
        var lng = position.coords.longitude;

        console.log("Position returned from geoloaction api, lat:"+lat+", "+lng+".");
        get_nearest_station_from_backend(lat,lng);
      }



      // Callback function that will handle error from the geolocation api,
      function callback_handle_position_error(error) {
        var err_str = "Unhandled error from geolocation api."

        switch(error.code) {
          case error.PERMISSION_DENIED:
            err_str = "User denied the request for geolocation."
            break;
          case error.POSITION_UNAVAILABLE:
            err_str = "Location information is unavailable."
            break;
          case error.TIMEOUT:
            err_str = "The request to get user location timed out."
            break;
          case error.UNKNOWN_ERROR:
            err_str = "An unknown error occurred."
            break;
        }

        console.log(error);
        console.log(err_str);
        $("#posfound").html('<li>'+err_str+'</li>');
      }



      // Callback function that will populate the list with found stations,
      function callback_populate_stations(found_stations, lat, lng, epoch_ajax_start) {

        var dropdowncontent = document.getElementById("dropdowncontent");
        var stations        = $("#dropdowncontent a span.listtext");

        var found;
        var epoch_ajax_done = (new Date).getTime();
            diff = epoch_ajax_done - epoch_ajax_start;

        var input = document.getElementById("where_are_you");
        var offset          = $(input).offset().top+$(input).outerHeight();
        var height          = window.innerHeight - 140;

        // Size the dropdown menu,
        // TODO Fix so menu adopts when phone keyboard is brought out,
        dropdowncontent.style.top       = offset;
        dropdowncontent.style.width     = $(input).outerWidth();
        dropdowncontent.style.maxHeight = height;

        // Populate list,
        for (i = 0; i < found_stations.length; i++) {
          $("#posfound").append("<li>"+found_stations[i].name+", "+found_stations[i].dist+
                                "meter, "+"din nuvarande position, lat: "+lat+", lng: "+
                                 lng+", "+epoch_ajax_start+", calltime :"+diff+".");

          // Loop all a's and match to our filter,
          for (j = 0; j < stations.length; j++) {
            stations_name = $(stations[j]).text().trim();
            //console.log(stations_name);
            //   txtValue = a[j].textContent || a[j].innerText;
            console.log("Comparing ->"+stations_name+"<- with ->"+found_stations[i].name+"<-")
            if (stations_name == found_stations[i].name) {
              console.log(stations_name);
              console.log($(stations[j]).parent().show());
          //     console.log("found stations)
          //     a[j].style.display = "";
               found=1;
             } else {
              console.log($(stations[j]).parent().hide());
             }
          }

          // // This is just to hide the whole div, otherwise it leaves
          // // a mark on the search box
           if (found){
             dropdowncontent.style.display="block";
           }else{
             dropdowncontent.style.display="none";
           }

        }


      }















      // Toggle selected line,
      function toggleLine(line) {
        if( $(".slmap."+line).is(":hidden") ) {
          $(".slmap").hide();
          $(".slmap."+line).show();
          $(".line").addClass("inactive").filter("."+line).removeClass("inactive");
        } else {
          $(".slmap").hide().filter(".all").show();
          $(".line").removeClass("inactive");
        }
      }












      var global_foo = 0;

      function getpos_stack() {

        //Dummy one, which will result in a working next statement.
        navigator.geolocation.getCurrentPosition(function () {}, function () {}, {});

        //The working next statement.
        var options = { maximumAge: 0, timeout: 10000, enableHighAccuracy: true };
        global_foo = 2;
        navigator.geolocation.getCurrentPosition(handle_position,
                                                 handle_position_error,
                                                 options);
      }
    </script>
  </body>
</html>
