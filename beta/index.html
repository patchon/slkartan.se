<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.googletagmanager.com/gtag/js?id=UA-132320676-1" async></script>
    <!-- Will replace this key when I have something working -->
    <!-- Until then, yes they key will be visible here -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAFpzssk3-zq2I4-mwmicEeyXna2hVp4wE&libraries=places"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-132320676-1');
    </script>

    <link href="assets/css/font.css" rel="stylesheet">
    <link href="assets/css/slkartan.css?v=20190120" rel="stylesheet">
  </head>

  <body>
    <div class="wrapper">
      <div class="side">
        <header>
          <h1>SL<strong>KARTAN</strong></h1><div class="version">v 0.1a</div>
          <!--<div class="getpos"> Get closest subway </div>-->

          <!-- Testing dropdown alternatives -->
          <div id="dropdowndiv">

            <input type="text" placeholder="Vart vill du åka ?" id="wheretogoinput" onfocusout="hidelist()" onfocus="filterlist()" onkeyup="filterlist()">
            <div class="dropdowncontent" id="dropdowncontent">

              <!-- Centralen, handle separetely -->
              <a href="#about"><span class="listtext">T-Centralen         </span><div class="listitem"><label class="pink">&nbsp;</label><label class="blue">&nbsp</label><label class="green">&nbsp;</label><label class="red">&nbsp;</label></div></a>

              <!-- BLÅ -->
              <!-- 10, 11, 17, 18, 19 -->
              <a href="#about"><span class="listtext">Fridhemsplan        </span><div class="listitem"><label class="blue">10 11</label><label class="green">17 18 19</label></div></a>

              <!-- 10, 11 -->
              <a href="#about"><span class="listtext">Kungsträdgården     </span><div class="listitem"><label class="blue">10 11</label></div></a>
              <a href="#about"><span class="listtext">Rådhuset            </span><div class="listitem"><label class="blue">10 11</label></div></a>
              <a href="#about"><span class="listtext">Stadshagen          </span><div class="listitem"><label class="blue">10 11</label></div></a>
              <a href="#about"><span class="listtext">Västra Skogen       </span><div class="listitem"><label class="blue">10 11</label></div></a>

              <!-- 10 -->
              <a href="#about"><span class="listtext">Huvudsta            </span><div class="listitem"><label class="blue">10 11</label></div></a>
              <a href="#about"><span class="listtext">Solna Strand        </span><div class="listitem"><label class="blue">10 11</label></div></a>

              <!-- 10, 43, 44 -->
              <a href="#about"><span class="listtext">Sundbyberg Centrum  </span><div class="listitem"><label class="blue">10</label><label class="pink">43 44</label></div></a>
              <a href="#about"><span class="listtext">Solna Centrum       </span><div class="listitem"><label class="blue">10</label><label class="pink">43 44</label></div></a>

              <!-- 10 -->
              <a href="#about"><span class="listtext">Duvbo               </span><div class="listitem"><label class="blue">10 11</label></div></a>
              <a href="#about"><span class="listtext">Rissne              </span><div class="listitem"><label class="blue">10 11</label></div></a>
              <a href="#about"><span class="listtext">Rinkeby             </span><div class="listitem"><label class="blue">10 11</label></div></a>
              <a href="#about"><span class="listtext">Tensta              </span><div class="listitem"><label class="blue">10 11</label></div></a>
              <a href="#about"><span class="listtext">Hjulsta             </span><div class="listitem"><label class="blue">10 11</label></div></a>

              <!-- 11 -->
              <a href="#about"><span class="listtext">Näckrosen           </span><div class="listitem"><label class="blue">11</label></div></a>
              <a href="#about"><span class="listtext">Hallonbergen        </span><div class="listitem"><label class="blue">11</label></div></a>
              <a href="#about"><span class="listtext">Kista               </span><div class="listitem"><label class="blue">11</label></div></a>
              <a href="#about"><span class="listtext">Husby               </span><div class="listitem"><label class="blue">11</label></div></a>
              <a href="#about"><span class="listtext">Akalla              </span><div class="listitem"><label class="blue">11</label></div></a>

              <!-- RÖD -->
              <!-- 13 -->
              <a href="#about"><span class="listtext">Norsborg            </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Hallunda            </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Alby                </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Fittja              </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Masmo               </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Vårby Gård          </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Vårberg             </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Skärholmen          </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Sätra               </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Bredäng             </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Mälarhöjden         </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Axelsberg           </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Örnsberg            </span><div class="listitem"><label class="red">13</label></div></a>
              <a href="#about"><span class="listtext">Aspudden            </span><div class="listitem"><label class="red">13</label></div></a>

              <!-- 13, 14 -->
              <a href="#about"><span class="listtext">Liljeholmen         </span><div class="listitem"><label class="red">13 14</label></div></a>
              <a href="#about"><span class="listtext">Hornstull           </span><div class="listitem"><label class="red">13 14</label></div></a>
              <a href="#about"><span class="listtext">Zinkensdamm         </span><div class="listitem"><label class="red">13 14</label></div></a>

              <!-- 13, 14 -->
              <a href="#about"><span class="listtext">Mariatorget         </span><div class="listitem"><label class="red">13 14</label></div></a>

              <!-- 40, 41, 42, 43, 44, 45, 48 -->
              <a href="#about"><span class="listtext">Stockholm Södra     </span><div class="listitem"><label class="pink">40 - 48</label></div></a>

              <!-- 13, 14, 17, 18, 19 -->
              <a href="#about"><span class="listtext">Slussen             </span><div class="listitem"><label class="red">13 14</label><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Gamla Stan          </span><div class="listitem"><label class="red">13 14</label><label class="green">17 18 19</label></div></a>

              <!-- 13, 14 -->
              <a href="#about"><span class="listtext">Östermalmstorg      </span><div class="listitem"><label class="red">13 14</label></div></a>

              <!-- GRÖN -->
              <!-- 17 -->
              <a href="#about"><span class="listtext">Skarpnäck      </span><div class="listitem"><label class="green">17</label></div></a>
              <a href="#about"><span class="listtext">Bagarmossen    </span><div class="listitem"><label class="green">17</label></div></a>
              <a href="#about"><span class="listtext">Kärrtorp       </span><div class="listitem"><label class="green">17</label></div></a>
              <a href="#about"><span class="listtext">Björkhagen     </span><div class="listitem"><label class="green">17</label></div></a>
              <a href="#about"><span class="listtext">Hammarbyhöjden </span><div class="listitem"><label class="green">17</label></div></a>
              <a href="#about"><span class="listtext">Skärmarbrink   </span><div class="listitem"><label class="green">17</label></div></a>

              <!--17, 18, 19 -->
              <a href="#about"><span class="listtext">Gullmarsplan       </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Skanstull          </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Medborgarplatsen   </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Hötorget           </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Rådmansgatan       </span><div class="listitem"><label class="green">17 18 19</label></div></a>

              <!-- 17, 18, 19, 40, 41, 42, 43, 44, 45, 48 -->
              <a href="#about"><span class="listtext">Odenplan           </span><div class="listitem"><label class="green">17 18 19</label><label class="pink">40 - 48</label></div></a>


              <!--17, 18, 19 -->
              <a href="#about"><span class="listtext">S:t Eriksplan      </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Thorildsplan       </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Kristineberg       </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Alvik              </span><div class="listitem"><label class="green">17 18 19</label></div></a>

              <a href="#about"><span class="listtext">Stora Mossen       </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Abrahamsberg       </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Brommaplan         </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Åkeshov            </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Ängbyplan          </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Islandstorget      </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Blackeberg         </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Råcksta            </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Vällingby          </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Johannelund        </span><div class="listitem"><label class="green">17 18 19</label></div></a>
              <a href="#about"><span class="listtext">Hässelby Gård      </span><div class="listitem"><label class="green">17 18 19</label></div></a>












            </div>
          </div>

          <!-- Testing google maps api -->
          <div>
            <ol id="posfound"></ol>
          </div>

        </header>

        <!-- Header Tunnelbana-->
        <div class="type">
          <h2>
            <img src="assets/imgs/tbana.png">
            <span>
              Tunnelbana
              <strong>Metro</strong>
            </span>
          </h2>

          <!-- Blue line -->
          <div class="line blue" data-color="blue">
            <div>
              <label>10</label>
              <label>11</label>
              <figure></figure>
            </div>
            <p>Blå linjen <strong>Blue Line</strong></p>
          </div>

          <!-- Red line -->
          <div class="line red" data-color="red">
            <div>
              <label>13</label>
              <label>14</label>
              <figure></figure>
            </div>
            <p>Röda linjen <strong>Red Line</strong></p>
          </div>


          <!-- Green line -->
          <div class="line green" data-color="green">
            <div>
              <label>17</label>
              <label>18</label>
              <label>19</label>
              <figure></figure>
            </div>
            <p>Gröna linjen <strong>Green Line</strong></p>
          </div>
        </div>

        <!-- Header Pendel -->
        <div class="type">
          <h2>
            <img src="assets/imgs/pendel.png">
            <span>
              Pendeltåg
              <strong>Commuter rail</strong>
            </span>
          </h2>

          <!-- All pendel lines -->
          <div class="line pink" data-color="pink">
            <div>
              <label>40</label>
              <label>41</label>
              <label>42</label>
              <label>43</label>
              <label>44</label>
              <label>45</label>
              <label>48</label>
              <figure></figure>
            </div>
            <!-- <p>Pendeltåg <strong>Commuter rail</strong></p>-->
          </div>
        </div>
      </div>

      <!-- The actual maps -->
      <div class="content">
        <div class="map">
          <div class="position"></div>
            <img class="slmap all"   src="assets/imgs/maps/slmap_all_line.png"   style="display:block">
            <img class="slmap blue"  src="assets/imgs/maps/slmap_blue_line.png"  style="display:none">
            <img class="slmap green" src="assets/imgs/maps/slmap_green_line.png" style="display:none">
            <img class="slmap red"   src="assets/imgs/maps/slmap_red_line.png"   style="display:none">
            <img class="slmap pink"  src="assets/imgs/maps/slmap_pink_line.png"  style="display:none">
        </div>
      </div>
    </div>

    <div id="map_dummy" style="display:none"></div>

    <script>

      // Stuff we do when dom is ready,
      $(document).ready(function(){

        // Sort of hacky, dont really care though,
        var width = $("#wheretogoinput").outerWidth();
        var height = $(window).height()-150;

        $(".dropdowncontent").css("max-width",width);
        $(".dropdowncontent").css("min-width",width);
        $(".dropdowncontent").css("max-height",height);
      });

      // Toggle selected line,
      function toggleLine(line) {
        if( $(".slmap."+line).is(":hidden") ) {
          $(".slmap").hide();
          $(".slmap."+line).show();
          $(".line").addClass("inactive").filter("."+line).removeClass("inactive");
        } else {
          $(".slmap").hide().filter(".all").show();
          $(".line").removeClass("inactive");
        }
      }

      // Bindings,
      $(".line").on("click", function() {
        lineColor = $(this).data("color");
        toggleLine(lineColor);
      });

      $(".getpos").on("click", function() {
        init_geo();
      });

      $("a").on("click", function() {
        lineColor = $(this).data("color")
        console.log($(this).children('div.listitem').find('label').attr('class'))
      });

      // Function that will filter the dropdown list based on input,
      function filterlist(){

        var input, filter, found, div, a, i, found;

        // Input element and dropdown-content,
        input = document.getElementById("wheretogoinput");
        dropdowncontent = document.getElementById("dropdowncontent");

        // Get the input,
        filter = input.value.toLowerCase();

        // Hide content if we dont have any input,
        if (filter == ""){
          dropdowncontent.style.display = "none"
          return
        }

        // Get all a's within our dropdown
        a = dropdowncontent.getElementsByTagName("a");

        // Loop all a's and match to our filter,
        for (i = 0; i < a.length; i++) {
          txtValue = a[i].textContent || a[i].innerText;
          if (txtValue.toLowerCase().indexOf(filter) > -1) {
            a[i].style.display = "";
            found=1;
          } else {
            a[i].style.display = "none";
          }
        }

        // This is just to hide the whole div, otherwise it leaves
        // a mark on the search box
        if (found){
          dropdowncontent.style.display="block";
        }else{
          dropdowncontent.style.display="none";
        }
      }


      // Function that just will hide the dropdown, called when input focus
      // is lost,
      function hidelist(){
        dropdowncontent = document.getElementById("dropdowncontent");
        dropdowncontent.style.display = "none"
      }


      // Function to initialize geo,
      function init_geo() {

        // Debug, mock data,
        var mock=0;
        var coords_mock_hogdalen = {};
            coords_mock_hogdalen['coords'] = {
              latitude  : 59.264973,
              longitude : 18.036123
            };

        // Our actual position,
        var current_location;

        // Request position,
        if (mock){
          console.log("mock data used");
          handle_position(coords_mock_hogdalen);
        }else{
          console.log("no mock");
          getlatlng();
        }
      };

      // Function that will ask the browser for the position.
      function getlatlng() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(handle_position,
                                                   handle_position_error);
        }else{
          console.log("Browser doesn't support geolocation.");
        }
      }

      // Function that will handle error from the geolocation api,
      function handle_position_error(error) {
        console.log(error);
        var err_str = "Unhandled error from geolocation api."

        switch(error.code) {
          case error.PERMISSION_DENIED:
            err_str = "User denied the request for geolocation."
            break;
          case error.POSITION_UNAVAILABLE:
            err_str = "Location information is unavailable."
            break;
          case error.TIMEOUT:
            err_str = "The request to get user location timed out."
            break;
          case error.UNKNOWN_ERROR:
            err_str = "An unknown error occurred."
            break;
        }

        $("#posfound").html('<li>'+err_str+'</li>');
      }

      // Function that will handle long, lats given by the browser.
      function handle_position(position) {
        console.log("Input location data : ");
        console.log(position);

        current_location = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };

        // Load map over sthlm
        var map = new google.maps.Map(document.getElementById('map_dummy'), {
          center: current_location,
        });

        // Use places to get nearest subway station. The callback
        // will handle the result,
        var service = new google.maps.places.PlacesService(map);
            service.nearbySearch({
              location  : current_location,
              radius    : 500,
              type      : ['subway_station']
            }, callback_subway_station);
      }


      // Callback function that will handle the data from the google maps api
      function callback_subway_station(results, status) {
        console.log(results)
        console.log(status)

        $("#posfound").html('');

        if (status == "OK"){
          $.each( results, function( key, value ) {
            $("#posfound").append('<li>'+value.name+'</li>');
          });
        }else if (status == "ZERO_RESULTS"){
          $("#posfound").append('<li>No subway within 500 meters found</li>');
        }else{
          $("#posfound").append('<li>Unhandled error.</li>');
        }
      }
    </script>
  </body>
</html>
